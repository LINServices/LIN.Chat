@page "/newprofile"

@inject NavigationManager nav
@inject IJSRuntime js


<!-- Propiedades -->
@code {


    /// <summary>
    /// Email de la cuenta
    /// </summary>
    private string EmailBind { get; set; } = string.Empty;


    /// <summary>
    /// Pais de la cuenta
    /// </summary>
    private string CountryBind { get; set; } = "0";


    /// <summary>
    /// OTP
    /// </summary>
    private string OTPBind { get; set; } = "";


    /// <summary>
    /// ID del perfil
    /// </summary>
    private int ProfileID { get; set; } = 0;


   // List<PaisDataModel> Paises = new();

}






















@code {


    bool IngresingMail { get; set; } = false;


    private string Necesidad { get; set; } = "0";

    private int Seccion = 0;

    private string Img64
    {
        get
        {
            return Convert.ToBase64String(LIN.Access.Developer.Session.Instance.Account.Perfil);
        }
    }







    protected override async void OnInitialized()
    {

        var res = await LIN.Access.Developer.Controllers.Profile.Find(LIN.Access.Developer.Session.Instance.Informacion.ID);

        // var paises = await LIN.Access.Controllers.Api.GetPaises();
        // Paises = paises.Models;

        // if (res.Response == Responses.Success && res.Model.ID > 0)
        // {
        //     Seccion = 2;
        //     ProfileID = res.Model.ID;
        //     EmailBind = res.Model.Email ?? "";

        // }
        base.StateHasChanged();
        base.OnInitialized();
    }






}


@if (!LIN.Access.Developer.Session.IsAccountOpen)
{
    nav.NavigateTo("/login");
    return;
}
@if (LIN.Access.Developer.Session.IsDevOpen)
{
    nav.NavigateTo("/");
    return;
}


<!--CSS-->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">

<style>

    .login,
    .image {
        min-height: 100vh;
    }

    .bg-image {
        background-image: url('./bg2.jpg');
        background-size: cover;
        background-position: center center;
    }

</style>




<div class="container-fluid bg-white">
    <div class="row no-gutter">


        <!-- Contenido -->
        <div class="col-md-6 bg-white">
            <div class="login d-flex align-items-center py-5">

                <!-- Demo content-->
                <div class="container">
                    <div class="row">

                        <div class="relative z-10 flex flex-1 flex-col bg-white px-4 py-10 sm:justify-center md:flex-none md:px-28">
                            <div class="mx-auto w-full max-w-md sm:px-4 md:w-96 md:max-w-sm md:px-0">
                                <div class="flex flex-col">

                                    @if (Seccion != 3)
                                    {
                                        <!--Nombre-->
                                        <div class="flex flex-row items-center">
                                            <img class="self-center" src="./img/cloud.png" style="height:40px; width: 40px" />
                                            <label class="text-xl self-center ml-2 gilroy-bold">
                                                Prueba
                                                <span class="text-blue-600"> LIN</span> Gratis

                                            </label>
                                        </div>


                                        <!-- Info de la sesion -->
                                        <div class="mt-10">

                                            <div class="flex flex-row">
                                                <img class="w-10 h-10 p-1 rounded-full ring-2 ring-gray-300" src="data:image/png;base64,@Img64" alt="Bordered avatar">

                                                <div class="flex flex-col ml-3">
                                                    <label>@LIN.Access.Developer.Session.Instance.Account.Nombre</label>
                                                    <label style="font-size: 12px" class="-mt-1 text-gray-600 hover:text-gray-900">@@@LIN.Access.Developer.Session.Instance.Account.Usuario</label>
                                                </div>
                                            </div>
                                        </div>
                                    }

                                </div>

                                <div class="mt-6 grid grid-cols-1">


                                    @if (Seccion == 0)
                                    {
                                        <!--Pais-->
                                        <label class="block mb-2 text-sm font-medium text-gray-900">
                                            Pais
                                        </label>
                                        <select @bind="CountryBind" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 ">

                                            <option value="0" selected>Selecciona un pais</option>
                                            @* @foreach (var pais in Paises)
                                            {
                                                <option value="@pais.ShortName">@pais.Nombre</option>
                                            } *@

                                        </select>


                                        <!--Uso-->
                                        <label class="block mb-2 text-sm font-medium text-gray-900 mt-4">
                                            ¿Cuál de las siguientes opciones describe mejor tus necesidades?
                                        </label>
                                        <select @bind="Necesidad" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 ">
                                            <option value="0" selected>Selecciona una opcion</option>
                                            <option value="1">Empresarial</option>
                                            <option value="2">Aprendizaje</option>
                                            <option value="3">Personal</option>
                                        </select>

                                        <!--Boton-->
                                        <div class="flex flex-row mt-4">
                                            <button @onclick="ValidateData" class="group inline-flex items-center justify-center rounded-full py-2 px-4 text-sm font-semibold focus:outline-none focus-visible:outline-2 focus-visible:outline-offset-2 bg-blue-600 text-white hover:text-slate-100 hover:bg-blue-500 active:bg-blue-800 active:text-blue-100 focus-visible:outline-blue-600 w-full">
                                                <span>Continuar <span aria-hidden="true">→</span></span>
                                            </button>
                                        </div>
                                    }

                                    else if (Seccion == 1)
                                    {

                                        <!--Creditos extras-->
                                        <label class="block mb-2 text-sm font-medium text-gray-900">
                                            Ingresa tu correo electronico.
                                        </label>

                                        <label style="font-size: 12px;" class="block mb-2 font-medium text-gray-500">
                                            Si tu correo pertence a algunos de estos dominios puedes acceder a <span class="text-blue-600 gilroy-bold">300</span> creditos extras. <span @onmouseenter="ShowPop" id="openMouse" class="text-blue-600 hover:text-blue-800 gilroy-bold underline">Ver lista</span>
                                        </label>

                                        <div class="mt-3">
                                            <label for="email" class="mb-2 block text-sm font-medium text-gray-700">
                                                ¿Cual es tu correo?
                                            </label>
                                            <input type="text"
                                                   autocomplete="off"
                                                   required=""
                                            @bind="EmailBind"
                                                   class="block w-full appearance-none rounded-md border border-gray-200 bg-gray-50 px-3 py-2 text-gray-900 placeholder-gray-400 focus:border-blue-500 focus:bg-white focus:outline-none focus:ring-blue-500 sm:text-sm">
                                        </div>


                                        <!--Boton-->
                                        <div class="flex flex-row mt-4">
                                            <button @onclick="GenerarPerfil" class="group inline-flex items-center justify-center rounded-full py-2 px-4 text-sm font-semibold focus:outline-none focus-visible:outline-2 focus-visible:outline-offset-2 bg-blue-600 text-white hover:text-slate-100 hover:bg-blue-500 active:bg-blue-800 active:text-blue-100 focus-visible:outline-blue-600 w-full">
                                                <span>Continuar <span aria-hidden="true">→</span></span>
                                            </button>
                                        </div>



                                        <div id="popover-default" role="tooltip" class="absolute z-10 invisible inline-block w-64 text-sm text-gray-500 transition-opacity duration-300 bg-white border border-gray-200 rounded-lg shadow-sm opacity-0">
                                            <div class="flex px-3 py-2 bg-gray-100 border-b border-gray-200 rounded-t-lg items-center">
                                                <h6 class="font-semibold text-gray-900">Dominios</h6>
                                            </div>
                                            <div class="px-3 py-2">
                                                <p class="hover:text-blue-500">@@Soy.sena.edu.co</p>
                                                <p class="hover:text-blue-500">@@Misena.edu.co</p>
                                                <p class="hover:text-blue-500">@@Envigado.edu.co</p>
                                            </div>
                                        </div>

                                    }

                                    else if (Seccion == 2)
                                    {

                                        @if (!IngresingMail)
                                        {

                                            <div class="mt-3">
                                                <label style="font-size: 12px" for="email" class="mb-2 block text-gray-700">
                                                    Ingresa codigo de seguridad enviado a <span @onclick="()=>{IngresingMail = true; base.StateHasChanged();}" class="text-blue-500 gilroy-bold">@EmailBind</span>
                                                </label>
                                                <input type="text"
                                                       autocomplete="off"
                                                       required=""
                                                @bind="OTPBind"
                                                       class="block w-full appearance-none rounded-md border border-gray-200 bg-gray-50 px-3 py-2 text-gray-900 placeholder-gray-400 focus:border-blue-500 focus:bg-white focus:outline-none focus:ring-blue-500 sm:text-sm">
                                            </div>

                                            <!--Boton-->
                                            <div class="flex flex-row mt-4">
                                                <button @onclick="ValidarOTP" class="group inline-flex items-center justify-center rounded-full py-2 px-4 text-sm font-semibold focus:outline-none focus-visible:outline-2 focus-visible:outline-offset-2 bg-blue-600 text-white hover:text-slate-100 hover:bg-blue-500 active:bg-blue-800 active:text-blue-100 focus-visible:outline-blue-600 w-full">
                                                    <span>Continuar <span aria-hidden="true">→</span></span>
                                                </button>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="mt-3">
                                                <label style="font-size: 12px" for="email" class="mb-2 block text-gray-700">
                                                    Ingresa el nuevo <span class="text-blue-500 gilroy-bold">correo</span>
                                                </label>
                                                <input type="text"
                                                       autocomplete="off"
                                                       required=""
                                                @bind="EmailBind"
                                                       class="block w-full appearance-none rounded-md border border-gray-200 bg-gray-50 px-3 py-2 text-gray-900 placeholder-gray-400 focus:border-blue-500 focus:bg-white focus:outline-none focus:ring-blue-500 sm:text-sm">
                                            </div>

                                            <!--Boton-->
                                            <div class="flex flex-row mt-4">
                                                <button @onclick="SendNewMail" class="group inline-flex items-center justify-center rounded-full py-2 px-4 text-sm font-semibold focus:outline-none focus-visible:outline-2 focus-visible:outline-offset-2 bg-blue-600 text-white hover:text-slate-100 hover:bg-blue-500 active:bg-blue-800 active:text-blue-100 focus-visible:outline-blue-600 w-full">
                                                    <span>Aceptar <span aria-hidden="true">→</span></span>
                                                </button>
                                            </div>
                                        }



                                    }

                                    else if (Seccion == 3)
                                    {
                                        <div class="flex w-full h-full items-center justify-center">
                                            <CircleLoader />
                                        </div>
                                    }


                                </div>

                            </div>
                        </div>


                    </div>
                </div>

            </div>
        </div>


        <!-- Imagen -->
        <div class="col-md-6 d-none d-md-flex bg-image hidden sm:contents lg:relative lg:block lg:flex-1" />



    </div>
</div>



@functions {


    /// <summary>
    /// Genera el perfil
    /// </summary>
    async void GenerarPerfil()
    {

        string? mail = null;

        if (!LIN.Modules.Mail.Validar(EmailBind))
        {
            ModalError.Show("El Email es invalido");
            return;
        }

        mail = EmailBind;

        // Pantalla Cargando
        Seccion = 3;
        base.StateHasChanged();

        // Modelo
        var modelo = new ProfileDataModel()
            {
                Description = $"Hola, soy {LIN.Access.Developer.Session.Instance.Account.Nombre}",
                Name = LIN.Access.Developer.Session.Instance.Account.Nombre,
                AccountID = LIN.Access.Developer.Session.Instance.Account.ID,
                Email = mail
            };

        // Resultado
        var result = await LIN.Access.Developer.Controllers.Profile.Generate(modelo);


        // Evalua el resultado
        if (result.Response != Responses.Success)
        {
            ModalError.Show("Hubo un error");
            return;
        }

        // Pantalla OTP
        ProfileID = result.LastID;
        Seccion = 2;
        base.StateHasChanged();

    }



    /// <summary>
    /// Valida datos de pais y necesidad
    /// </summary>
    void ValidateData()
    {
        // Valida el pais
        if (CountryBind == "0")
        {
            ModalError.Show("Selecciona un pais");
            return;
        }

        // Valida la necesidad
        if (Necesidad == "0")
        {
            ModalError.Show("Selecciona una opcion que se adapte para que vas a usar LIN");
            return;
        }

        Seccion = 1;
        base.StateHasChanged();

    }



    /// <summary>
    /// Valida el OTP
    /// </summary>
    async void ValidarOTP()
    {

        Seccion = 3;
        base.StateHasChanged();

        // OTP result
        var response = await LIN.Access.Developer.Controllers.Profile.ValidateOTP(ProfileID, OTPBind);

        // Valida la respuesta
        if (response.Response == Responses.Success)
        {
            Star();
        }
        else
        {
            Seccion = 2;
            base.StateHasChanged();
            ModalError.Show("Codigo OTP invalido");
        }
    }



    /// <summary>
    /// </summary>
    async void SendNewMail()
    {

        Seccion = 3;
        base.StateHasChanged();

        // OTP result
        var response = await LIN.Access.Developer.Controllers.Profile.ReplaceProfileMail(ProfileID, EmailBind);

        // Valida la respuesta
        if (response.Response != Responses.Success)
        {
            ModalError.Show("No se pudo actualizar el correo.");
        }

        IngresingMail = false;
        Seccion = 2;
        base.StateHasChanged();
    }



    /// <summary>
    /// Iniciar Sesion (DEV)
    /// </summary>
    async void Star()
    {
       // var loginDev = await LIN.Access.Developer.Session.LoginWith(LIN.Access.Developer.Session.Instance.Account.ID);
        nav.NavigateTo("/");
    }



    /// <summary>
    /// Muestra en tooltip
    /// </summary>
    async void ShowPop()
    {
        await js.InvokeVoidAsync("ShowPop", "popover-default", "openMouse");
    }


}